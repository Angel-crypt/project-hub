<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Project Hub{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/logo/logo.ico') }}">
    <link rel="shortcut icon" type="image/x-icon" href="{{ url_for('static', filename='images/logo/logo.ico') }}">

    <!-- Web App Icons -->
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/logo/logo.png') }}">
    <meta name="theme-color" content="#2563eb">

    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">

    {% block extra_head %}{% endblock %}
</head>

<body>
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="flash-message flash-{{ category }}">
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- Error Modal -->
    {% if error %}
    <div class="error-overlay" onclick="if(event.target===this)this.style.display='none'">
        <div class="error-modal">
            <button class="error-close" onclick="this.closest('.error-overlay').style.display='none'">&times;</button>
            <img src="https://http.cat/{{ status_code }}" alt="Error {{ status_code }}">
            <p>{{ error }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Client-Side Error Modal (for AJAX) -->
    <div id="error-display" class="error-overlay" style="display: none;"
        onclick="if(event.target===this)this.style.display='none'">
        <div class="error-modal">
            <button class="error-close"
                onclick="document.getElementById('error-display').style.display='none'">&times;</button>
            <img id="error-cat" src="" alt="Error Cat">
            <p id="error-message"></p>
        </div>
    </div>

    {% if session.get('user_id') %}
    <div class="app-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-header-top">
                    <h2 class="sidebar-title">ProjectHub</h2>
                    <button class="sidebar-toggle" id="sidebar-toggle" title="Compactar menú">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="11 17 6 12 11 7"></polyline>
                            <polyline points="18 17 13 12 18 7"></polyline>
                        </svg>
                    </button>
                </div>
                <span class="sidebar-role">{{ session.get('role', '') | upper }}</span>
            </div>

            <nav class="sidebar-nav">
                <a href="{{ url_for('home') }}" class="sidebar-link" title="Inicio">
                    <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    <span class="sidebar-label">Inicio</span>
                </a>
                <a href="{{ url_for('call.view_all') }}" class="sidebar-link" title="Convocatorias">
                    <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <span class="sidebar-label">Convocatorias</span>
                </a>

                {% if session.get('role') in ['owner', 'admin'] %}
                <a href="{{ url_for('project.view_all') }}" class="sidebar-link" title="Proyectos">
                    <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span class="sidebar-label">Proyectos</span>
                </a>
                <a href="{{ url_for('user.manage_user') }}" class="sidebar-link" title="Usuarios">
                    <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <span class="sidebar-label">Usuarios</span>
                </a>
                {% endif %}

                {% if session.get('role') == 'owner' %}
                <a href="{{ url_for('user.manage_admin') }}" class="sidebar-link" title="Administradores">
                    <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="8.5" cy="7" r="4"></circle>
                        <line x1="20" y1="8" x2="20" y2="14"></line>
                        <line x1="23" y1="11" x2="17" y2="11"></line>
                    </svg>
                    <span class="sidebar-label">Administradores</span>
                </a>
                {% endif %}

                {% if session.get('role') == 'leader' %}
                <a href="{{ url_for('project.view_all') }}" class="sidebar-link" title="Mis Proyectos">
                    <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span class="sidebar-label">Mis Proyectos</span>
                </a>
                {% endif %}
            </nav>

            <div class="sidebar-bottom">
                <span class="sidebar-user">{{ session.get('user_name', '') }}</span>
                <a href="{{ url_for('auth.logout') }}" class="sidebar-link sidebar-logout" title="Cerrar Sesión">
                    <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    <span class="sidebar-label">Cerrar Sesión</span>
                </a>
            </div>
        </aside>

        <main class="main-content">
            {% endif %}

            {% block content %}{% endblock %}

            {% if session.get('user_id') %}
        </main>
    </div>
    {% endif %}

    <footer class="app-footer {% if session.get('user_id') %}app-footer--auth{% endif %}">
        <p>ProjectHub &copy; 2025</p>
    </footer>

    {% block scripts %}{% endblock %}

    {% if session.get('user_id') %}
    <script>
        (function () {
            var toggle = document.getElementById('sidebar-toggle');
            if (!toggle) return;

            if (localStorage.getItem('sidebar-collapsed') === 'true') {
                document.body.classList.add('sidebar-collapsed');
            }

            toggle.addEventListener('click', function () {
                document.body.classList.toggle('sidebar-collapsed');
                localStorage.setItem('sidebar-collapsed', document.body.classList.contains('sidebar-collapsed'));
            });
        })();
    </script>
    {% endif %}
    <script src="{{ url_for('static', filename='js/error-handler.js') }}"></script>
</body>

</html>