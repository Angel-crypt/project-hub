{% extends 'base.html' %}

{% block title %}Project HUB - Detalle del Proyecto{% endblock %}

{% block content %}
<div class="page-header page-header--row">
    <!-- Editable Title -->
    <div style="flex: 1; margin-right: 1rem;">
        <input type="text" id="project-name" class="editable-title" value="{{ project.name }}" readonly maxlength="80">
    </div>
    <a href="{{ url_for('project.view_all') }}" class="btn-secondary" title="Volver">
        Volver
    </a>
</div>

<div class="content-card">
    <div class="detail-section">
        <h3>Descripción</h3>
        <!-- Editable Description -->
        <textarea id="project-description" class="editable-description" readonly rows="5"
            maxlength="255">{{ project.description }}</textarea>
    </div>

    <!-- Static Details -->
    <div class="detail-grid">
        <div class="detail-item">
            <span class="detail-label">Convocatoria</span>
            <span class="detail-value">{{ project.call.title if project.call else 'Sin Convocatoria' }}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Líder</span>
            <span class="detail-value">{{ project.leader.name if project.leader else 'Sin líder' }}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Fecha de Creación</span>
            <span class="detail-value">{{ project.created_at.strftime('%d/%m/%Y') }}</span>
        </div>
    </div>

    <!-- Actions Section -->
    <div class="actions-container"
        style="margin-top: 2rem; border-top: 1px solid #e5e7eb; padding-top: 1.5rem; display: flex; gap: 1rem;">
        {% set is_leader = session.get('user_id') == project.leader_id %}
        {% set is_admin = session.get('role') in ['owner', 'admin'] %}

        <!-- View Mode Actions -->
        <div id="view-actions" style="display: flex; gap: 1rem;">
            {% if is_leader %}
            <button type="button" class="btn-create" onclick="toggleEditMode(true)">
                Editar
            </button>
            {% endif %}

            {% if is_leader or is_admin %}
            <button type="button" class="btn-danger"
                onclick="openConfirmModalCustom('{{ url_for('project.delete_project', project_id=project.id) }}', '{{ project.name }}')">
                Eliminar
            </button>
            {% endif %}
        </div>

        <!-- Edit Mode Actions (Hidden by default) -->
        <div id="edit-actions" style="display: none; gap: 1rem;">
            <button type="button" class="btn-create" id="btn-save" onclick="saveProjectChanges()">
                Guardar
            </button>
            <button type="button" class="btn-secondary" onclick="cancelEdit()">
                Cancelar
            </button>
        </div>
    </div>
</div>

<!-- Archivos del Proyecto -->
<div class="detail-section" style="margin-top: 3rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3>Archivos del Proyecto</h3>
        {% if is_leader and project.deliverables %}
        <button class="btn-create" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;" onclick="openUploadModal()">
            + Subir archivo
        </button>
        {% endif %}
    </div>

    {% if not project.deliverables %}
    <div class="empty-state" style="text-align: center; padding: 3rem; background: #f9fafb; border-radius: 8px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"
            fill="none" stroke="#9ca3af" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
            style="margin-bottom: 1rem;">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
        </svg>
        <p style="margin-bottom: 0.5rem; color: #6b7280; font-weight: 500;">No hay archivos cargados</p>
        <p style="margin-bottom: 1.5rem; color: #9ca3af; font-size: 0.85rem;">
            {% if is_leader %}
            Sube el primer archivo de tu proyecto para comenzar.
            {% else %}
            El l&iacute;der del proyecto a&uacute;n no ha subido archivos.
            {% endif %}
        </p>
        {% if is_leader %}
        <button class="btn-create" onclick="openUploadModal()">
            Subir archivo
        </button>
        {% endif %}
    </div>
    {% else %}
    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Descripci&oacute;n</th>
                    <th>Fecha</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for deliverable in project.deliverables %}
                <tr>
                    <td style="font-weight: 500;">{{ deliverable.name }}</td>
                    <td>{{ deliverable.description }}</td>
                    <td>{{ deliverable.created_at.strftime('%d/%m/%Y') }}</td>
                    <td>
                        <div class="table-actions">
                            <a href="{{ url_for('deliverable.view_deliverable', deliverable_id=deliverable.id) }}"
                                class="btn-action" title="Ver" target="_blank">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </a>
                            <a href="{{ url_for('deliverable.download_deliverable', deliverable_id=deliverable.id) }}"
                                class="btn-action" title="Descargar" target="_blank">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                            </a>

                            {% if is_leader %}
                            <button class="btn-action btn-edit" title="Editar"
                                onclick="openEditFileModal({{ deliverable.id }}, '{{ deliverable.description | e }}')">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            {% endif %}

                            {% if is_admin or (is_leader and session.get('user_id') == project.leader_id) %}
                            <button class="btn-action btn-delete" title="Eliminar"
                                onclick="openConfirmModalCustom('{{ url_for('deliverable.delete_deliverable', deliverable_id=deliverable.id) }}', '{{ deliverable.name }}')">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path
                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                    </path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h2>Subir Archivo</h2>
            <button class="modal-close" onclick="closeUploadModal()">&times;</button>
        </div>
        <form id="uploadForm" action="{{ url_for('deliverable.upload_deliverable', project_id=project.id) }}"
            method="POST" enctype="multipart/form-data" onsubmit="submitUpload(event)">
            <div class="form-group">
                <label for="upload-name">Nombre</label>
                <input type="text" id="upload-name" name="name" class="form-input" required maxlength="80">
            </div>
            <div class="form-group">
                <label for="upload-desc">Descripci&oacute;n</label>
                <textarea id="upload-desc" name="description" class="form-input" rows="3" required></textarea>
            </div>
            <div class="form-group">
                <label>Archivo</label>
                <input type="file" id="upload-file" name="file" required
                    accept=".pdf,.doc,.docx,.png,.jpg,.jpeg" style="display: none;">
                <!-- Drop zone / browse button -->
                <div id="file-dropzone" onclick="document.getElementById('upload-file').click()"
                    style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.2s; background: #f9fafb;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"
                        fill="none" stroke="#9ca3af" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                        style="margin-bottom: 0.5rem;">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <p style="margin: 0; color: #6b7280; font-size: 0.9rem;">
                        Haz clic para seleccionar un archivo
                    </p>
                    <p style="margin: 0.25rem 0 0 0; color: #9ca3af; font-size: 0.78rem;">
                        PDF, DOCX, Im&aacute;genes &middot; M&aacute;x 10MB
                    </p>
                </div>
                <!-- Selected file preview -->
                <div id="file-preview" style="display: none; border: 1px solid #d1d5db; border-radius: 8px; padding: 0.75rem 1rem; background: #f9fafb; margin-top: 0;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; min-width: 0;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="#6b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink: 0;">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>
                            <div style="min-width: 0;">
                                <p id="file-name" style="margin: 0; font-size: 0.9rem; font-weight: 500; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></p>
                                <p id="file-size" style="margin: 0; font-size: 0.78rem; color: #9ca3af;"></p>
                            </div>
                        </div>
                        <button type="button" onclick="removeSelectedFile(event)" title="Quitar archivo"
                            style="background: none; border: none; cursor: pointer; color: #9ca3af; padding: 0.25rem; display: flex; align-items: center; flex-shrink: 0;"
                            onmouseover="this.style.color='#dc2626'" onmouseout="this.style.color='#9ca3af'">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div class="confirm-actions">
                <button type="button" class="btn-cancel" onclick="closeUploadModal()">Cancelar</button>
                <button type="submit" class="btn-create">Subir</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit File Modal -->
<div id="editFileModal" class="modal-overlay">
    <div class="modal modal--sm">
        <div class="modal-header">
            <h2>Editar Archivo</h2>
            <button class="modal-close" onclick="closeEditFileModal()">&times;</button>
        </div>
        <form id="editFileForm" onsubmit="submitEditFile(event)">
            <input type="hidden" id="edit-file-id">
            <div class="form-group">
                <label for="edit-file-desc">Descripci&oacute;n</label>
                <textarea id="edit-file-desc" class="form-input" rows="3" required></textarea>
            </div>
            <div class="confirm-actions">
                <button type="button" class="btn-cancel" onclick="closeEditFileModal()">Cancelar</button>
                <button type="submit" class="btn-create" id="btn-edit-file-save">Guardar</button>
            </div>
        </form>
    </div>
</div>

<!-- Confirm Modal Include -->
{% include 'partials/_confirm_modal.html' %}

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/user-actions.js') }}"></script>
<script>
    // Store original values to revert on cancel
    let originalName = "{{ project.name }}";
    let originalDescription = `{{ project.description }}`;
    const projectId = {{ project.id }};
    const updateUrl = "{{ url_for('project.update_project', project_id=project.id) }}";

    function toggleEditMode(enable) {
        const nameInput = document.getElementById('project-name');
        const descInput = document.getElementById('project-description');
        const viewActions = document.getElementById('view-actions');
        const editActions = document.getElementById('edit-actions');

        if (enable) {
            nameInput.removeAttribute('readonly');
            descInput.removeAttribute('readonly');
            nameInput.focus();
            viewActions.style.display = 'none';
            editActions.style.display = 'flex';
        } else {
            nameInput.setAttribute('readonly', true);
            descInput.setAttribute('readonly', true);
            viewActions.style.display = 'flex';
            editActions.style.display = 'none';
        }
    }

    function cancelEdit() {
        // Revert values
        document.getElementById('project-name').value = originalName;
        document.getElementById('project-description').value = originalDescription;
        toggleEditMode(false);
    }

    function saveProjectChanges() {
        const name = document.getElementById('project-name').value.trim();
        const description = document.getElementById('project-description').value.trim();
        const btnSave = document.getElementById('btn-save');

        if (!name) {
            alert("El nombre del proyecto es obligatorio.");
            return;
        }

        btnSave.disabled = true;
        btnSave.textContent = "Guardando...";

        fetch(updateUrl, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ name: name, description: description })
        })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(res => {
                if (res.status === 200) {
                    // Update original values
                    originalName = name;
                    originalDescription = description;
                    toggleEditMode(false);
                    // Optional: Show success message/toast
                } else {
                    alert(res.body.error || "Error al actualizar el proyecto.");
                    // Check if validation errors exist
                    if (res.body.errors) {
                        console.error(res.body.errors);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Error de conexión al guardar.");
            })
            .finally(() => {
                btnSave.disabled = false;
                btnSave.textContent = "Guardar";
            });
    }

    // File Upload Logic
    const fileInput = document.getElementById('upload-file');
    const dropzone = document.getElementById('file-dropzone');
    const filePreview = document.getElementById('file-preview');
    const fileNameEl = document.getElementById('file-name');
    const fileSizeEl = document.getElementById('file-size');

    fileInput.addEventListener('change', function () {
        if (this.files.length > 0) {
            showFilePreview(this.files[0]);
        }
    });

    function showFilePreview(file) {
        fileNameEl.textContent = file.name;
        fileSizeEl.textContent = formatFileSize(file.size);
        dropzone.style.display = 'none';
        filePreview.style.display = 'block';
    }

    function removeSelectedFile(e) {
        e.stopPropagation();
        fileInput.value = '';
        filePreview.style.display = 'none';
        dropzone.style.display = 'block';
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / 1048576).toFixed(1) + ' MB';
    }

    function openUploadModal() {
        document.getElementById('uploadModal').style.display = 'flex';
    }

    function closeUploadModal() {
        document.getElementById('uploadModal').style.display = 'none';
        document.getElementById('uploadForm').reset();
        filePreview.style.display = 'none';
        dropzone.style.display = 'block';
    }

    function submitUpload(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const btn = form.querySelector('button[type="submit"]');
        const originalText = btn.textContent;

        btn.disabled = true;
        btn.textContent = "Subiendo...";

        fetch(form.action, {
            method: 'POST',
            body: formData
        })
            .then(res => res.json().then(data => ({ status: res.status, body: data })))
            .then(result => {
                if (result.status === 201) {
                    window.location.reload();
                } else {
                    alert(result.body.error || "Error al subir el archivo.");
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            })
            .catch(err => {
                console.error(err);
                alert("Error de conexión.");
                btn.disabled = false;
                btn.textContent = originalText;
            });
    }


    // Edit File Logic
    function openEditFileModal(fileId, description) {
        document.getElementById('edit-file-id').value = fileId;
        document.getElementById('edit-file-desc').value = description;
        document.getElementById('editFileModal').style.display = 'flex';
    }

    function closeEditFileModal() {
        document.getElementById('editFileModal').style.display = 'none';
        document.getElementById('editFileForm').reset();
    }

    function submitEditFile(event) {
        event.preventDefault();
        const fileId = document.getElementById('edit-file-id').value;
        const description = document.getElementById('edit-file-desc').value.trim();
        const btn = document.getElementById('btn-edit-file-save');

        if (!description) {
            alert("La descripción es obligatoria.");
            return;
        }

        btn.disabled = true;
        btn.textContent = "Guardando...";

        fetch('/deliverable/' + fileId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ description: description })
        })
            .then(res => res.json().then(data => ({ ok: res.ok, data: data })))
            .then(result => {
                if (result.ok) {
                    window.location.reload();
                } else {
                    alert(result.data.error || 'Error al actualizar.');
                }
            })
            .catch(() => alert("Error de conexión."))
            .finally(() => {
                btn.disabled = false;
                btn.textContent = "Guardar";
            });
    }

    // Custom helper to handle delete with redirect
    // Reuse openConfirmModal from user-actions.js regarding UI, 
    // but we need to override the submit action to redirect instead of reload.
    // Since user-actions.js uses a global _deleteUrl and submitConfirm(), 
    // we can overwrite submitConfirm on this page or use a separate modal mechanism.
    // The easiest way is to use the existing modal but change what submitConfirm does.

    // Check if user-actions.js defines submitConfirm attached to window or global scope.
    // Yes, it defines `function submitConfirm()`.
    // We can overwrite it for this page.

    // Store the original function if needed, but here we just want custom behavior.
    const originalSubmitConfirm = window.submitConfirm;

    const projectDeleteUrl = "{{ url_for('project.delete_project', project_id=project.id) }}";

    window.submitConfirm = function () {
        if (!_deleteUrl) return;

        fetch(_deleteUrl, { method: 'DELETE' })
            .then(function (res) { return res.json().then(function (data) { return { ok: res.ok, data: data }; }); })
            .then(function (result) {
                if (result.ok) {
                    if (_deleteUrl === projectDeleteUrl) {
                        window.location.href = "{{ url_for('project.view_all') }}";
                    } else {
                        window.location.reload();
                    }
                } else {
                    closeConfirmModal();
                    alert(result.data.error || 'Error al eliminar.');
                }
            });
    };

    function openConfirmModalCustom(url, name) {
        // Just call the global from user-actions.js, the overridden submitConfirm will handle the rest
        openConfirmModal(url, name);
    }
</script>
{% endblock %}